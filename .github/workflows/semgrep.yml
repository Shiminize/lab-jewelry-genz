# Semgrep Security Scanning Workflow
# Automated security scanning for GlowGlitch e-commerce platform
# Runs on every push and pull request to protect against vulnerabilities

name: Security Audit with Semgrep

on:
  # Scan on every push to main and pull requests
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  
  # Manual trigger for ad-hoc security scans
  workflow_dispatch:
  
  # Weekly full security scan
  schedule:
    - cron: '0 2 * * 0'  # Every Sunday at 2 AM UTC

jobs:
  semgrep:
    name: Security Scan
    runs-on: ubuntu-latest
    
    # Security permissions for uploading results
    permissions:
      contents: read
      security-events: write
      actions: read
    
    # Skip scanning if commit message contains [skip security]
    if: "!contains(github.event.head_commit.message, '[skip security]')"
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # Fetch full history for better analysis
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Verify Node and npm versions
        run: node -v && npm -v
      
      - name: Install Dependencies
        run: npm ci --ignore-scripts
        
      - name: Run Semgrep Security Scan
        uses: semgrep/semgrep-action@v1
        with:
          config: .semgrep.yml
          publishToken: ${{ secrets.SEMGREP_APP_TOKEN }}
        env:
          # GitHub token for API access
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
          # Optional: Semgrep App token for cloud features
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
      
      - name: Security Scan Summary
        if: always()
        run: |
          echo "## ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f semgrep.json ]; then
            # Parse results and create summary
            ERRORS=$(jq '.results[] | select(.extra.severity == "ERROR") | length' semgrep.json 2>/dev/null || echo "0")
            WARNINGS=$(jq '.results[] | select(.extra.severity == "WARNING") | length' semgrep.json 2>/dev/null || echo "0") 
            INFO=$(jq '.results[] | select(.extra.severity == "INFO") | length' semgrep.json 2>/dev/null || echo "0")
            
            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸš¨ ERROR | $ERRORS |" >> $GITHUB_STEP_SUMMARY
            echo "| âš ï¸ WARNING | $WARNINGS |" >> $GITHUB_STEP_SUMMARY  
            echo "| â„¹ï¸ INFO | $INFO |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "$ERRORS" -gt "0" ]; then
              echo "âŒ **Security scan failed** - Critical vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Action Required:** Fix all ERROR-level security issues before merging." >> $GITHUB_STEP_SUMMARY
              echo "View detailed results in the [Security tab](https://github.com/${{ github.repository }}/security/code-scanning)." >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **Security scan passed** - No critical vulnerabilities detected." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â„¹ï¸ Security scan completed - check logs for details." >> $GITHUB_STEP_SUMMARY
          fi
      
      # Fail the job if critical vulnerabilities are found
      - name: Check for Critical Vulnerabilities  
        if: always()
        run: |
          if [ -f semgrep.json ]; then
            ERRORS=$(jq '.results[] | select(.extra.severity == "ERROR") | length' semgrep.json 2>/dev/null || echo "0")
            if [ "$ERRORS" -gt "0" ]; then
              echo "âŒ Found $ERRORS critical security vulnerabilities!"
              echo "ðŸ” Review the Security tab for detailed findings."
              echo "ðŸš« Blocking deployment until all critical issues are resolved."
              exit 1
            fi
          fi
          
          echo "âœ… No critical security vulnerabilities found."

  # Additional job for payment-specific security validation
  payment-security:
    name: Payment Security Validation
    runs-on: ubuntu-latest
    needs: semgrep
    if: contains(github.event.head_commit.message, 'payment') || contains(github.event.head_commit.message, 'stripe') || contains(github.event.head_commit.message, 'checkout')
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Enhanced Payment Security Scan
        uses: semgrep/semgrep-action@v1
        with:
          config: >
            p/security-audit
            p/owasp-top-ten
            p/cwe-top-25
            p/pci-dss
          auditOn: push
          
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Validate PCI DSS Compliance
        run: |
          echo "ðŸ”’ Running PCI DSS compliance checks..."
          
          # Check for sensitive data logging
          if grep -r "console\.log.*card\|console\.log.*cvv\|console\.log.*payment" src/app/api/payments/ src/app/api/checkout/ 2>/dev/null; then
            echo "âŒ CRITICAL: Payment data found in console.log statements!"
            exit 1
          fi
          
          # Check for hardcoded secrets
          if grep -r "sk_live_\|sk_test_" src/ --exclude-dir=node_modules 2>/dev/null; then
            echo "âŒ CRITICAL: Hardcoded Stripe keys found!"
            exit 1
          fi
          
          echo "âœ… PCI DSS basic compliance checks passed."

  # Dependency vulnerability scanning
  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Verify Node and npm versions
        run: node -v && npm -v
      
      - name: Run npm audit
        run: |
          echo "ðŸ” Scanning dependencies for vulnerabilities..."
          npm audit --audit-level=high --production
          
      - name: Generate Dependency Report
        run: |
          echo "## ðŸ“¦ Dependency Security Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get vulnerability counts
          AUDIT_OUTPUT=$(npm audit --json 2>/dev/null || echo '{"vulnerabilities":{}}')
          HIGH=$(echo "$AUDIT_OUTPUT" | jq '.metadata.vulnerabilities.high // 0')
          CRITICAL=$(echo "$AUDIT_OUTPUT" | jq '.metadata.vulnerabilities.critical // 0')
          
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”¥ Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš¨ High | $HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$CRITICAL" -gt "0" ] || [ "$HIGH" -gt "0" ]; then
            echo "âš ï¸ **Action Required:** Update vulnerable dependencies before production deployment." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **All dependencies secure** - No high or critical vulnerabilities found." >> $GITHUB_STEP_SUMMARY
          fi
